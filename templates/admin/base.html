<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Admin Panel{% endblock %} - SantBhagatRam</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body class="admin-shell">
    <header class="admin-topbar">
        <div class="brand">
            <div class="brand-icon">SB</div>
            <div class="brand-copy">
                <span class="brand-label">SantBhagatRam</span>
                <span class="brand-subtext">Admin Control</span>
            </div>
        </div>
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">☰</button>
        <nav class="topbar-nav" id="topbarNav">
            <a href="{{ url_for('admin_dashboard') }}" class="{% if request.endpoint == 'admin_dashboard' %}active{% endif %}">Dashboard</a>
            <a href="{{ url_for('admin_blogs') }}" class="{% if 'admin_blogs' in request.endpoint or 'admin_add_blog' in request.endpoint or 'admin_edit_blog' in request.endpoint %}active{% endif %}">Blogs</a>
            <a href="{{ url_for('admin_events') }}" class="{% if 'admin_events' in request.endpoint or 'admin_add_event' in request.endpoint or 'admin_edit_event' in request.endpoint %}active{% endif %}">Events</a>
            <a href="{{ url_for('admin_photos') }}" class="{% if 'admin_photos' in request.endpoint or 'admin_add_photo_gallery' in request.endpoint or 'admin_edit_photo_gallery' in request.endpoint %}active{% endif %}">Photos</a>
            <a href="{{ url_for('admin_slider') }}" class="{% if 'admin_slider' in request.endpoint or 'admin_add_slider_image' in request.endpoint or 'admin_edit_slider_image' in request.endpoint %}active{% endif %}">Slider</a>
            <a href="{{ url_for('admin_navbar_dropdowns') }}" class="{% if 'admin_navbar_dropdowns' in request.endpoint or 'admin_manage_dropdown' in request.endpoint or 'admin_add_dropdown_column' in request.endpoint or 'admin_edit_dropdown_column' in request.endpoint or 'admin_add_dropdown_item' in request.endpoint or 'admin_edit_dropdown_item' in request.endpoint or 'admin_edit_global_social_media' in request.endpoint %}active{% endif %}">Navbar Dropdowns</a>
        </nav>
        <div class="topbar-actions">
            <a href="/" target="_blank" class="ghost-btn">View Site</a>
            <a href="{{ url_for('admin_logout') }}" class="primary-btn">Sign Out</a>
        </div>
    </header>

    <main class="admin-main-area">
        <section class="page-heading">
            <div>
                <p class="eyebrow">Control center</p>
                <h1>{% block page_title %}Admin Panel{% endblock %}</h1>
            </div>
            <div class="page-heading-actions">
                {% block page_actions %}{% endblock %}
            </div>
        </section>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <span>{{ message }}</span>
                            <button class="flash-close" onclick="this.parentElement.remove()">×</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="admin-content">
            {% block content %}{% endblock %}
        </div>
    </main>

    <script>
        // Mobile menu toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const topbarNav = document.getElementById('topbarNav');
        
        if (mobileMenuToggle && topbarNav) {
            mobileMenuToggle.addEventListener('click', function() {
                topbarNav.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.admin-topbar')) {
                    topbarNav.classList.remove('active');
                }
            });
        }
        
        // Auto-hide flash messages
        setTimeout(function() {
            document.querySelectorAll('.flash-message').forEach(msg => {
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 300);
            });
        }, 4000);

        // Session timeout and activity tracking
        // Backend enforces absolute 5-minute timeout
        // Client-side provides failsafe redirect to /logout after 5 minutes
        (function() {
            const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds (failsafe)
            const WARNING_TIME = 30 * 1000; // Show warning 30 seconds before timeout (4.5 minutes)
            // Removed automatic ping interval - only ping on actual user activity
            
            let lastActivity = Date.now();
            let warningShown = false;
            let warningTimeout;
            let logoutTimeout; // Client-side failsafe timeout
            
            // Activity events to track (mousemove, click, keydown as specified)
            const activityEvents = ['mousemove', 'click', 'keydown', 'mousedown', 'keypress', 'scroll', 'touchstart'];
            
            function resetTimers() {
                lastActivity = Date.now();
                warningShown = false;
                
                // Clear existing timers
                if (warningTimeout) clearTimeout(warningTimeout);
                if (logoutTimeout) clearTimeout(logoutTimeout);
                
                // Set warning timer (1.5 minutes)
                warningTimeout = setTimeout(showWarning, INACTIVITY_TIMEOUT - WARNING_TIME);
                
                // Set client-side failsafe logout timer (2 minutes) - redirects to /logout
                logoutTimeout = setTimeout(clientSideLogout, INACTIVITY_TIMEOUT);
            }
            
            function clientSideLogout() {
                // Client-side failsafe: redirect to /logout after 2 minutes of inactivity
                window.location.href = '{{ url_for("admin_logout") }}';
            }
            
            function showWarning() {
                if (warningShown) return;
                warningShown = true;
                
                const warningDiv = document.createElement('div');
                warningDiv.id = 'session-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f59e0b;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-family: "Inter", sans-serif;
                    font-size: 14px;
                    max-width: 350px;
                    animation: slideIn 0.3s ease;
                `;
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 20px;">⚠️</span>
                        <div>
                            <strong>Session Expiring Soon</strong><br>
                            <span style="font-size: 12px; opacity: 0.9;">Your session will expire in 30 seconds due to inactivity. Move your mouse or click anywhere to stay logged in.</span>
                        </div>
                    </div>
                `;
                
                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(warningDiv);
                
                // Auto-hide warning if user becomes active
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.style.animation = 'slideIn 0.3s ease reverse';
                        setTimeout(() => warningDiv.remove(), 300);
                    }
                }, WARNING_TIME);
            }
            
            function handleSessionExpired() {
                // Show final message
                const logoutDiv = document.createElement('div');
                logoutDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 32px;
                    border-radius: 12px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    z-index: 10001;
                    text-align: center;
                    font-family: "Inter", sans-serif;
                `;
                logoutDiv.innerHTML = `
                    <h2 style="margin: 0 0 16px 0; color: #dc2626;">Session Expired</h2>
                    <p style="margin: 0 0 24px 0; color: #6b7280;">Your session has expired due to inactivity. Redirecting to login...</p>
                    <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: var(--bubblegum-pink); border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite;"></div>
                `;
                
                const spinStyle = document.createElement('style');
                spinStyle.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
                document.head.appendChild(spinStyle);
                
                document.body.innerHTML = '';
                document.body.appendChild(logoutDiv);
                
                // Redirect to login
                setTimeout(() => {
                    window.location.href = '{{ url_for("admin_login") }}';
                }, 2000);
            }
            
            function pingServer() {
                fetch('{{ url_for("admin_activity_ping") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (response.status === 401) {
                        // Session expired - backend enforced logout
                        handleSessionExpired();
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Already handled expired session
                    
                    if (!data.success || data.expired) {
                        // Session expired on server side - backend enforced
                        handleSessionExpired();
                    } else {
                        // Update last ping response
                        lastPingResponse = data;
                        
                        // Reset warning timer if session is still valid
                        if (warningShown) {
                            const warning = document.getElementById('session-warning');
                            if (warning) {
                                warning.style.animation = 'slideIn 0.3s ease reverse';
                                setTimeout(() => warning.remove(), 300);
                                warningShown = false;
                            }
                        }
                        resetTimers();
                    }
                })
                .catch(error => {
                    console.error('Activity ping failed:', error);
                    // On error, don't logout - let backend handle it on next request
                });
            }
            
            // Track user activity - reset timer on mousemove, click, or keydown
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    const now = Date.now();
                    // Only reset if significant time has passed (avoid spam)
                    if (now - lastActivity > 1000) {
                        // Reset client-side failsafe timer
                        resetTimers();
                        
                        // Ping server to update activity (backend enforces timeout)
                        pingServer();
                        
                        // Hide warning if shown
                        if (warningShown) {
                            const warning = document.getElementById('session-warning');
                            if (warning) {
                                warning.style.animation = 'slideIn 0.3s ease reverse';
                                setTimeout(() => warning.remove(), 300);
                                warningShown = false;
                            }
                        }
                    }
                }, true);
            });
            
            // Initialize timers
            resetTimers();
            
            // NO automatic ping interval - only ping on actual user activity
            // This allows the backend to properly enforce 5-minute inactivity timeout
            
            // Ping on page visibility change (user switches tabs) - only if tab becomes visible
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    // Only ping if user actually switches back to the tab (indicates activity)
                    pingServer();
                    resetTimers(); // Reset client-side timer when tab becomes visible
                }
            });
            
            // Initial ping on page load (to establish session)
            pingServer();
        })();
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>

