{% extends "base.html" %}

{% block title %}Videos - SantBhagatRam{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/videos.css') }}">
{% endblock %}

{% block content %}
<div class="videos-container">
    <!-- Header -->
    <div class="videos-header">
        <h1 data-lang-videos="title">वीडियो गैलरी</h1>
        <p data-lang-videos="subtitle">हमारे धार्मिक कार्यक्रमों, भजन संध्या और सेवा कार्यों के वीडियो</p>
    </div>

    <!-- Video Categories -->
    <div class="video-categories">
        <button class="category-btn active" data-category="all" data-lang-videos="all">All</button>
        <button class="category-btn" data-category="livestream" data-lang-videos="livestream">Livestreams</button>
        <button class="category-btn" data-category="video" data-lang-videos="videos">Videos</button>
    </div>

    <!-- Video Grid -->
    <div class="videos-grid" id="videosGrid">
        <div class="loading-spinner" id="loadingSpinner" style="text-align: center; width: 100%; padding: 40px;">
            <div class="spinner"
                style="border: 4px solid #f3f3f3; border-top: 4px solid var(--bubblegum-pink); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;">
            </div>
            <p style="margin-top: 10px; color: var(--text-light);">Loading videos...</p>
        </div>
        <!-- Videos will be populated here by JS -->
    </div>

    <div class="load-more-container" style="text-align: center; margin-top: 40px; display: none;">
        <button id="loadMoreBtn" class="category-btn"
            style="background: var(--bubblegum-pink); color: white; border: none;">Load More</button>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeVideoModal()">&times;</button>
            <div class="video-player">
                <iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="video-details">
                <h2 id="modalVideoTitle"></h2>
                <p id="modalVideoDate"></p>
                <p id="modalVideoDescription"></p>
                <a id="modalWatchLink" class="video-watch-link" href="#" target="_blank" rel="noopener noreferrer"
                    data-lang-videos="watchOnYoutube">Watch on YouTube</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
<script>
    /**
     * Generate responsive image attributes for Cloudinary URLs
     */
    function generateResponsiveImageAttrs(url, sizes, defaultWidth = 1200) {
        if (!url) {
            return { src: '', srcset: '', sizes: sizes || '' };
        }
        
        // Check if it's a Cloudinary URL
        const isCloudinary = url.includes('cloudinary.com') || url.includes('res.cloudinary.com');
        
        if (!isCloudinary) {
            // For non-Cloudinary URLs, return as-is
            return { src: url, srcset: '', sizes: sizes || '' };
        }
        
        // Generate srcset with multiple widths
        const widths = [400, 800, 1200, 1600, 2000];
        const srcsetParts = widths.map(width => {
            const transformedUrl = getCloudinaryUrl(url, width);
            return `${transformedUrl} ${width}w`;
        });
        
        // Generate default src
        const src = getCloudinaryUrl(url, defaultWidth);
        
        return {
            src: src,
            srcset: srcsetParts.join(', '),
            sizes: sizes || "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 800px"
        };
    }

    /**
     * Get Cloudinary URL with transformations
     */
    function getCloudinaryUrl(url, width) {
        if (!url || !url.includes('cloudinary.com')) {
            return url;
        }
        
        // Parse Cloudinary URL and add transformations
        if (url.includes('/upload/')) {
            const parts = url.split('/upload/');
            if (parts.length === 2) {
                const baseUrl = parts[0] + '/upload/';
                const pathPart = parts[1];
                
                // Build transformation string
                const transformations = [
                    'f_auto',      // Auto format (WebP, AVIF when supported)
                    'q_auto',      // Auto quality
                    `w_${width}`,  // Width
                    'dpr_auto',    // Device pixel ratio
                    'c_auto,g_auto' // Auto crop and gravity
                ];
                
                const transformStr = transformations.join(',');
                return `${baseUrl}${transformStr}/${pathPart}`;
            }
        }
        
        return url;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const videosGrid = document.getElementById('videosGrid');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadMoreContainer = document.querySelector('.load-more-container');
        const categoryBtns = document.querySelectorAll('.category-btn[data-category]');

        let allVideos = [];
        let currentCategory = 'all';
        let visibleCount = 6;
        const increment = 6;

        // Fetch videos asynchronously
        fetch('/api/videos?limit=50')
            .then(response => response.json())
            .then(data => {
                allVideos = data;
                loadingSpinner.style.display = 'none';
                if (allVideos.length === 0) {
                    videosGrid.innerHTML = '<div class="empty-state">No videos found.</div>';
                } else {
                    renderVideos();
                }
            })
            .catch(error => {
                console.error('Error fetching videos:', error);
                loadingSpinner.innerHTML = '<p style="color: red;">Error loading videos. Please try again later.</p>';
            });

        function createVideoCard(video) {
            const div = document.createElement('div');
            div.className = 'video-card';
            div.dataset.category = video.category;
            div.dataset.videoUrl = video.url;
            div.dataset.watchUrl = video.watch_url;
            div.style.display = 'none'; // Hidden by default

            // Generate responsive image attributes for video thumbnail
            const thumbnailAttrs = generateResponsiveImageAttrs(video.thumbnail, "(max-width: 640px) 100vw, (max-width: 1024px) 50vw, (max-width: 1440px) 33vw, 400px", 800);
            const playButtonAttrs = generateResponsiveImageAttrs("/static/images/slider/play-buttton.png", "60px", 60);
            
            div.innerHTML = `
                <div class="video-thumbnail">
                    <img src="${thumbnailAttrs.src}" 
                         srcset="${thumbnailAttrs.srcset}" 
                         sizes="${thumbnailAttrs.sizes}" 
                         alt="${video.title}" 
                         loading="lazy">
                    <div class="play-overlay">
                        <div class="video-play-button" aria-hidden="true">
                            <img src="${playButtonAttrs.src}" 
                                 srcset="${playButtonAttrs.srcset}" 
                                 sizes="${playButtonAttrs.sizes}" 
                                 alt="" 
                                 loading="lazy">
                        </div>
                    </div>
                </div>
                <div class="video-info">
                    <h3>${video.title}</h3>
                    <p class="video-date">${video.date}</p>
                    <p class="video-description">${video.description}</p>
                    <div class="video-actions">
                        <a class="video-watch-link" href="${video.watch_url}" target="_blank" rel="noopener noreferrer" data-lang-videos="watchOnYoutube">Watch on YouTube</a>
                    </div>
                </div>
            `;

            // Add click event
            div.addEventListener('click', function () {
                openVideoModal(video.title, video.date, video.description, video.url, video.watch_url);
            });

            // Add click event to watch link to prevent bubbling
            div.querySelector('.video-watch-link').addEventListener('click', function (e) {
                e.stopPropagation();
            });

            return div;
        }

        function renderVideos() {
            // Clear existing video cards (keep spinner if needed, but here we rebuild)
            // Actually, better to append once.
            // Let's clear grid except spinner
            videosGrid.innerHTML = '';
            videosGrid.appendChild(loadingSpinner); // Keep spinner hidden

            // Filter
            const filteredVideos = allVideos.filter(video => {
                return currentCategory === 'all' || video.category === currentCategory;
            });

            if (filteredVideos.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'No videos found in this category.';
                videosGrid.appendChild(empty);
                loadMoreContainer.style.display = 'none';
                return;
            }

            // Create elements for filtered videos
            filteredVideos.forEach((video, index) => {
                const card = createVideoCard(video);
                videosGrid.appendChild(card);

                // Show if within visible count
                if (index < visibleCount) {
                    card.style.display = 'block';
                    setTimeout(() => {
                        card.classList.add('visible');
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 10);
                }
            });

            // Handle Load More visibility
            if (visibleCount >= filteredVideos.length) {
                loadMoreContainer.style.display = 'none';
            } else {
                loadMoreContainer.style.display = 'block';
            }
        }

        // Category Click
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                categoryBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                visibleCount = increment; // Reset count
                renderVideos();
            });
        });

        // Load More Click
        loadMoreBtn.addEventListener('click', function () {
            visibleCount += increment;
            // Re-run logic to show more
            const cards = videosGrid.querySelectorAll('.video-card');
            let shown = 0;
            cards.forEach(card => {
                if (card.style.display !== 'none') shown++;
            });

            // We need to find hidden cards that match category and show them
            // Actually renderVideos rebuilds, which is inefficient but safe. 
            // Let's just update visibility to be smoother.

            const filteredCards = Array.from(videosGrid.querySelectorAll('.video-card')); // Already filtered by renderVideos? No, renderVideos appends all filtered.
            // Wait, renderVideos appends ONLY filtered videos.

            filteredCards.forEach((card, index) => {
                if (index < visibleCount) {
                    if (card.style.display === 'none') {
                        card.style.display = 'block';
                        // Trigger reflow
                        void card.offsetWidth;
                        card.classList.add('visible');
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }
                }
            });

            if (visibleCount >= filteredCards.length) {
                loadMoreContainer.style.display = 'none';
            }
        });
    });

    function openVideoModal(title, date, description, url, watchUrl) {
        document.getElementById('modalVideoTitle').textContent = title;
        document.getElementById('modalVideoDate').textContent = date;
        document.getElementById('modalVideoDescription').textContent = description;
        document.getElementById('videoFrame').src = url;
        const modalWatch = document.getElementById('modalWatchLink');
        if (modalWatch) {
            modalWatch.href = watchUrl || url;
        }
        document.getElementById('videoModal').classList.add('active');
    }

    function closeVideoModal() {
        document.getElementById('videoModal').classList.remove('active');
        document.getElementById('videoFrame').src = '';
    }

    // Close modal on outside click
    document.getElementById('videoModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeVideoModal();
        }
    });

    // Ensure translations are applied after page loads
    setTimeout(function () {
        if (window.applyLanguage) {
            const lang = window.getCurrentLanguage ? window.getCurrentLanguage() : 'hi';
            window.applyLanguage(lang);
        }
    }, 300);
</script>
{% endblock %}