{% extends "base.html" %}

{% block title %}Videos - SantBhagatRam{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/videos.css') }}">
{% endblock %}

{% block content %}
<div class="videos-container">
    <!-- Header -->
    <div class="videos-header">
        <h1 data-lang-videos="title">वीडियो गैलरी</h1>
        <p data-lang-videos="subtitle">हमारे धार्मिक कार्यक्रमों, भजन संध्या और सेवा कार्यों के वीडियो</p>
    </div>

    <!-- Video Categories -->
    <div class="video-categories">
        <button class="category-btn active" data-category="all" data-lang-videos="all">All</button>
        <button class="category-btn" data-category="livestream" data-lang-videos="livestream">Livestreams</button>
        <button class="category-btn" data-category="video" data-lang-videos="videos">Videos</button>
    </div>

    <!-- Video Grid -->
    <div class="videos-grid" id="videosGrid">
        {% if videos %}
        {% for video in videos %}
        <div class="video-card" data-category="{{ video.category }}" data-video-url="{{ video.url }}"
            data-watch-url="{{ video.watch_url }}" style="display: none;">
            <div class="video-thumbnail">
                <img src="{{ video.thumbnail }}" alt="{{ video.title }}">
                <div class="play-overlay">
                    <div class="video-play-button" aria-hidden="true">
                        <img src="{{ url_for('static', filename='images/slider/play-buttton.png') }}" alt=""
                            loading="lazy">
                    </div>
                </div>
            </div>
            <div class="video-info">
                <h3>{{ video.title }}</h3>
                <p class="video-date">{{ video.date }}</p>
                <p class="video-description">{{ video.description }}</p>
                <div class="video-actions">
                    <a class="video-watch-link" href="{{ video.watch_url }}" target="_blank" rel="noopener noreferrer"
                        data-lang-videos="watchOnYoutube">Watch on YouTube</a>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state">No videos found.</div>
        {% endif %}
    </div>

    <div class="load-more-container" style="text-align: center; margin-top: 40px;">
        <button id="loadMoreBtn" class="category-btn"
            style="background: var(--bubblegum-pink); color: white; border: none;">Load More</button>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeVideoModal()">&times;</button>
            <div class="video-player">
                <iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <div class="video-details">
                <h2 id="modalVideoTitle"></h2>
                <p id="modalVideoDate"></p>
                <p id="modalVideoDescription"></p>
                <a id="modalWatchLink" class="video-watch-link" href="#" target="_blank" rel="noopener noreferrer"
                    data-lang-videos="watchOnYoutube">Watch on YouTube</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const videosGrid = document.getElementById('videosGrid');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const categoryBtns = document.querySelectorAll('.category-btn[data-category]');
        let currentCategory = 'all';
        let visibleCount = 6;
        const increment = 6;

        function filterVideos() {
            const allVideos = Array.from(document.querySelectorAll('.video-card'));
            let filteredVideos = allVideos.filter(video => {
                return currentCategory === 'all' || video.dataset.category === currentCategory;
            });

            // Hide all first
            allVideos.forEach(video => {
                video.style.display = 'none';
                video.classList.remove('visible');
            });

            // Show subset of filtered
            const toShow = filteredVideos.slice(0, visibleCount);
            toShow.forEach(video => {
                video.style.display = 'block';
                // Trigger reflow for animation
                void video.offsetWidth;
                video.classList.add('visible');
                video.style.opacity = '1';
                video.style.transform = 'translateY(0)';
            });

            // Handle Load More button visibility
            if (visibleCount >= filteredVideos.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'inline-block';
            }
        }

        // Category Click
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                categoryBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.dataset.category;
                visibleCount = increment; // Reset count on category change
                filterVideos();
            });
        });

        // Load More Click
        loadMoreBtn.addEventListener('click', function () {
            visibleCount += increment;
            filterVideos();
        });

        // Initial Load
        filterVideos();
    });

    // Video card click
    document.querySelectorAll('.video-card').forEach(card => {
        card.addEventListener('click', function () {
            const title = this.querySelector('h3').textContent;
            const date = this.querySelector('.video-date').textContent;
            const description = this.querySelector('.video-description').textContent;
            const videoUrl = this.dataset.videoUrl;
            const watchUrl = this.dataset.watchUrl || videoUrl?.replace('/embed/', '/watch?v=');

            if (videoUrl) {
                openVideoModal(title, date, description, videoUrl, watchUrl);
            }
        });
    });

    document.querySelectorAll('.video-watch-link').forEach(link => {
        link.addEventListener('click', function (event) {
            event.stopPropagation();
        });
    });

    function openVideoModal(title, date, description, url, watchUrl) {
        document.getElementById('modalVideoTitle').textContent = title;
        document.getElementById('modalVideoDate').textContent = date;
        document.getElementById('modalVideoDescription').textContent = description;
        document.getElementById('videoFrame').src = url;
        const modalWatch = document.getElementById('modalWatchLink');
        if (modalWatch) {
            modalWatch.href = watchUrl || url;
        }
        document.getElementById('videoModal').classList.add('active');
    }

    function closeVideoModal() {
        document.getElementById('videoModal').classList.remove('active');
        document.getElementById('videoFrame').src = '';
    }

    // Close modal on outside click
    document.getElementById('videoModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeVideoModal();
        }
    });

    // Ensure translations are applied after page loads
    setTimeout(function () {
        if (window.applyLanguage) {
            const lang = window.getCurrentLanguage ? window.getCurrentLanguage() : 'hi';
            window.applyLanguage(lang);
        }
    }, 300);

    window.addEventListener('load', function () {
        setTimeout(function () {
            if (window.applyLanguage) {
                const lang = window.getCurrentLanguage ? window.getCurrentLanguage() : 'hi';
                window.applyLanguage(lang);
            }
        }, 200);
    });
</script>
{% endblock %}